
[DEBUG] [2018-12-21 00:00:33,975] [21] [	with a as(select t.parent_id parent_id, min(t.plan_code_gantt) min_task_code
  from mpm.pm_task_info t
 where t.actual_e_date is null
   and (t.accept_state <> '3' or t.accept_state is null)
   and t.task_type = '1'
   and t.id in (select pti.parent_id
                  from mpm.pm_task_info pti left join pt6.sys_user su
                       on pti.user_id = su.id
                 where pti.pm_task_type = '1' and (su.login_name='shaozj' or exists(
                 select 1 from tdm.tdm_task_rsrc_user ttru left join pt6.sys_user su1 on ttru.user_id = su1.id
                 where ttru.task_id = pti.id and su1.login_name = 'shaozj'
                 ))) --包含下达给试验部公布的工序
 group by t.parent_id
),
--查询所有任务下的按顺序应当执行的工序code对应的ID
b as (
  select a.parent_id,a.min_task_code,pti1.id from mpm.pm_task_info pti1,a
  where pti1.parent_id = a.parent_id 
  and pti1.task_name not like '%_A' AND  pti1.task_name NOT LIKE '%_B'
  and pti1.task_name not like '%_C' AND  pti1.task_name NOT LIKE '%_D'
),
--查询带ABCD的科研工序，只能查询上一未做的阶段工序
b1 as(
 select a.parent_id,a.min_task_code,pti1.id from mpm.pm_task_info pti1,a
  where pti1.parent_id = a.parent_id 
    and ((pti1.TASK_NAME  LIKE '%_A' AND nvl(pti1.ACTUAL_PROGRESS,0)<100)
OR(pti1.TASK_NAME LIKE '%_B' AND nvl(pti1.ACTUAL_PROGRESS,0)<100 AND 
 NOT EXISTS(SELECT 1 FROM mpm.PM_TASK_INFO WHERE PARENT_ID=pti1.PARENT_ID AND TASK_NAME LIKE '%_A' 
 AND nvl(ACTUAL_PROGRESS,0)<100))
 OR(pti1.TASK_NAME LIKE '%_C' AND nvl(pti1.ACTUAL_PROGRESS,0)<100 AND 
 NOT EXISTS(SELECT 1 FROM mpm.PM_TASK_INFO WHERE PARENT_ID=pti1.PARENT_ID AND TASK_NAME LIKE '%_B' 
 AND nvl(ACTUAL_PROGRESS,0)<100))
  OR(pti1.TASK_NAME LIKE '%_D' AND nvl(pti1.ACTUAL_PROGRESS,0)<100 AND 
 NOT EXISTS(SELECT 1 FROM mpm.PM_TASK_INFO WHERE PARENT_ID=pti1.PARENT_ID AND TASK_NAME LIKE '%_C' 
 AND nvl(ACTUAL_PROGRESS,0)<100))
 ) 
),
b2 as (
select parent_id,min_task_code,id from b
union all
select parent_id,min_task_code,id from b1
),
--查询该工序节点父节点和子节点的信息
d as(
  select distinct pti2.* from mpm.pm_task_info pti2,b2
  where pti2.parent_id = b2.id or b2.parent_id = pti2.id or pti2.id=b2.id
  and pti2.actual_e_date is null
  and pti2.accept_state <> '3'
),
--过滤工步不为登陆人的工步
c as (
  select d.* from d
  left join pt6.sys_user su
  on d.user_id=su.id
  where (su.login_name='shaozj' or exists(
                 select 1 from tdm.tdm_task_rsrc_user ttru left join pt6.sys_user su1 on ttru.user_id = su1.id
                 where ttru.task_id = d.id and su1.login_name = 'shaozj')) or d.task_type<>0
)
select c.id, --WBS/任务的唯一标识
       decode(c.task_type, 0, '工步', 1, '工序', 2, '里程碑', 3,'任务','') task_type, --类型
       pp.project_code, --项目code
       pp.project_name, --项目名称
       c.plan_s_date, --计划开始时间
       c.plan_e_date, --计划结束时间
       c.actual_s_date, --实际开始时间
       c.actual_e_date, --实际结束时间
       (select attribute_07 from mpm.pm_task_info where instr(c.task_path,id)>0 and        task_type='3')attribute_07, --任务项目编号
       c.plan_code_gantt, --任务名称
       c.task_name, --任务名称
       c.task_code, --任务code
       su.login_name, --登入名
       sdv.dept_name, --部门名称
       syu.login_name as PLAN_MANAGER_name, --主管名称
       c.INTERFACE_STATE , --任务状态
       c.parent_id --父节点ID
       from c
left join pt6.sys_user su
    on c.user_id = su.id --通过user_id左连接 系统用户表 拿到 用户登入名
  left join pt6.sys_user syu
    on c.plan_manager_id = syu.id --通过plan_manager_id左连接 系统用户表 拿到 主管名称
  left join pt6.sys_dept_v sdv
    on c.dept_id = sdv.id --通过dept_id左连接 部门表视图 拿到 部门名称
  left join pt6.pm_project pp
    on c.pm_project_id = pp.id --通过pm_project_id左连接 项目结构信息表 拿到 项目code 项目名称
 where c.task_status = '30' --状态 等于30(已下达)
   and nvl(c.ACTUAL_PROGRESS, 0) < 100 --并且 计划实际完成百分比%小于100 order by c.plan_code_gantt


]
[DEBUG] [2018-12-21 00:00:34,057] [21] [	SELECT * FROM MDS_IMP_DATA_SCRIPT]
[DEBUG] [2018-12-21 00:00:34,062] [21] [	SELECT * FROM MDS_IMP_DATA_SCRIPT WHERE FID='512950b178534c24a6033392af0bd08d']
[DEBUG] [2018-12-21 00:00:34,064] [21] [	SELECT * FROM MDS_IMP_DATA_SCRIPT_RULE WHERE FID='512950b178534c24a6033392af0bd08d']
[DEBUG] [2018-12-21 00:00:34,066] [21] [	SELECT * FROM MDS_IMP_DATA_SCRIPT_MAP WHERE MDS_IMP_DATA_SCRIPT_RULE_ID='512950b178534c24a6033392af0bd08d']
[DEBUG] [2018-12-21 00:00:34,069] [21] [	select t.table_name,t.column_name,t.data_type,t.data_length,t.nullable,t.column_id,c.comments
       FROM user_tab_cols t, user_col_comments c
       WHERE upper(t.table_name)='TBL_1220_DATA1'   
             and c.table_name=t.table_name   
             and c.column_name=t.column_name   
             and t.hidden_column='NO'   
 order by t.column_id ]
[INFO ] [2018-12-21 00:00:34,075] [21] [BetchLogic > updateDbByID > 删除数据:TBL_1220_DATA1 -> taskid: 8a53b79267c9ba700167c9bd4c2b0011  times: 1]
[DEBUG] [2018-12-21 00:00:34,075] [21] [	delete from TBL_1220_DATA1 where PROJECTID ='8a53b79267c9ba700167c9bd4c2b0011' and TASKTIMES=1]
[DEBUG] [2018-12-21 00:00:36,573] [21] [	select t.table_name,t.column_name,t.data_type,t.data_length,t.nullable,t.column_id,c.comments
       FROM user_tab_cols t, user_col_comments c
       WHERE upper(t.table_name)='TBL_1220_DATA1'   
             and c.table_name=t.table_name   
             and c.column_name=t.column_name   
             and t.hidden_column='NO'   
 order by t.column_id ]
[DEBUG] [2018-12-21 00:00:36,579] [21] [	INSERT INTO MDS_IMP_DATA_LOG(FID,TEST_PROJECT_ID,IMP_DATE_TIME,FULL_FLODERNAME,IMPROWSCOUNT,IMP_STATUS,ERROR_MSG,CREATED_BY,CREATION_DATE,LAST_UPDATED_BY,LAST_UPDATE_DATE,LAST_UPDATE_IP,VERSION,IMPFILENAME,OBJECT_TABLE,TYPENAME) VALUES('27ab8affc91746e7856010f9f29f3b6a','8a53b79267c9ba700167c9bd4c2b0011',to_date('2018/12/21 00:00:36','yyyy/mm/dd hh24:mi:ss'),'27ab8affc91746e7856010f9f29f3b6a.txt','0','','','4028b48152632a160152635092f7000e',to_date('2018/12/21 00:00:36','yyyy/mm/dd hh24:mi:ss'),'4028b48152632a160152635092f7000e',to_date('2018/12/21 00:00:36','yyyy/mm/dd hh24:mi:ss'),'127.0.0.1',1,'mx@1220,1.1.1.1,12202018000,1.txt','TBL_1220_DATA1','512950b178534c24a6033392af0bd08d')]
[DEBUG] [2018-12-21 00:00:36,584] [21] [	select t.table_name,t.column_name,t.data_type,t.data_length,t.nullable,t.column_id,c.comments
       FROM user_tab_cols t, user_col_comments c
       WHERE upper(t.table_name)='TBL_1220_DATA1'   
             and c.table_name=t.table_name   
             and c.column_name=t.column_name   
             and t.hidden_column='NO'   
 order by t.column_id ]
[INFO ] [2018-12-21 00:00:36,589] [21] [BetchLogic > run > 开始导入:2018/12/21 上午12:00:36]
[INFO ] [2018-12-21 00:00:37,345] [21] [BetchLogic > run > 凑够10000行写一次库 :9999]
[INFO ] [2018-12-21 00:00:37,678] [21] [BetchLogic > run > 凑够10000行写一次库 :19999]
[INFO ] [2018-12-21 00:00:37,977] [21] [BetchLogic > run > 凑够10000行写一次库 :29999]
[INFO ] [2018-12-21 00:00:39,225] [21] [BetchLogic > run > 凑够10000行写一次库 :39999]
[INFO ] [2018-12-21 00:00:39,497] [21] [BetchLogic > run > 凑够10000行写一次库 :49999]
[INFO ] [2018-12-21 00:00:39,803] [21] [BetchLogic > run > 凑够10000行写一次库 :59999]
[INFO ] [2018-12-21 00:00:40,076] [21] [BetchLogic > run > 凑够10000行写一次库 :69999]
[INFO ] [2018-12-21 00:00:40,352] [21] [BetchLogic > run > 凑够10000行写一次库 :79999]
[INFO ] [2018-12-21 00:00:40,658] [21] [BetchLogic > run > 凑够10000行写一次库 :89999]
[INFO ] [2018-12-21 00:00:40,932] [21] [BetchLogic > run > 凑够10000行写一次库 :99999]
[INFO ] [2018-12-21 00:00:40,932] [21] [BetchLogic > run > 全部写入完成:100000]
[DEBUG] [2018-12-21 00:00:41,288] [15] [	with a as(select t.parent_id parent_id, min(t.plan_code_gantt) min_task_code
  from mpm.pm_task_info t
 where t.actual_e_date is null
   and (t.accept_state <> '3' or t.accept_state is null)
   and t.task_type = '1'
   and t.id in (select pti.parent_id
                  from mpm.pm_task_info pti left join pt6.sys_user su
                       on pti.user_id = su.id
                 where pti.pm_task_type = '1' and (su.login_name='shaozj' or exists(
                 select 1 from tdm.tdm_task_rsrc_user ttru left join pt6.sys_user su1 on ttru.user_id = su1.id
                 where ttru.task_id = pti.id and su1.login_name = 'shaozj'
                 ))) --包含下达给试验部公布的工序
 group by t.parent_id
),
--查询所有任务下的按顺序应当执行的工序code对应的ID
b as (
  select a.parent_id,a.min_task_code,pti1.id from mpm.pm_task_info pti1,a
  where pti1.parent_id = a.parent_id 
  and pti1.task_name not like '%_A' AND  pti1.task_name NOT LIKE '%_B'
  and pti1.task_name not like '%_C' AND  pti1.task_name NOT LIKE '%_D'
),
--查询带ABCD的科研工序，只能查询上一未做的阶段工序
b1 as(
 select a.parent_id,a.min_task_code,pti1.id from mpm.pm_task_info pti1,a
  where pti1.parent_id = a.parent_id 
    and ((pti1.TASK_NAME  LIKE '%_A' AND nvl(pti1.ACTUAL_PROGRESS,0)<100)
OR(pti1.TASK_NAME LIKE '%_B' AND nvl(pti1.ACTUAL_PROGRESS,0)<100 AND 
 NOT EXISTS(SELECT 1 FROM mpm.PM_TASK_INFO WHERE PARENT_ID=pti1.PARENT_ID AND TASK_NAME LIKE '%_A' 
 AND nvl(ACTUAL_PROGRESS,0)<100))
 OR(pti1.TASK_NAME LIKE '%_C' AND nvl(pti1.ACTUAL_PROGRESS,0)<100 AND 
 NOT EXISTS(SELECT 1 FROM mpm.PM_TASK_INFO WHERE PARENT_ID=pti1.PARENT_ID AND TASK_NAME LIKE '%_B' 
 AND nvl(ACTUAL_PROGRESS,0)<100))
  OR(pti1.TASK_NAME LIKE '%_D' AND nvl(pti1.ACTUAL_PROGRESS,0)<100 AND 
 NOT EXISTS(SELECT 1 FROM mpm.PM_TASK_INFO WHERE PARENT_ID=pti1.PARENT_ID AND TASK_NAME LIKE '%_C' 
 AND nvl(ACTUAL_PROGRESS,0)<100))
 ) 
),
b2 as (
select parent_id,min_task_code,id from b
union all
select parent_id,min_task_code,id from b1
),
--查询该工序节点父节点和子节点的信息
d as(
  select distinct pti2.* from mpm.pm_task_info pti2,b2
  where pti2.parent_id = b2.id or b2.parent_id = pti2.id or pti2.id=b2.id
  and pti2.actual_e_date is null
  and pti2.accept_state <> '3'
),
--过滤工步不为登陆人的工步
c as (
  select d.* from d
  left join pt6.sys_user su
  on d.user_id=su.id
  where (su.login_name='shaozj' or exists(
                 select 1 from tdm.tdm_task_rsrc_user ttru left join pt6.sys_user su1 on ttru.user_id = su1.id
                 where ttru.task_id = d.id and su1.login_name = 'shaozj')) or d.task_type<>0
)
select c.id, --WBS/任务的唯一标识
       decode(c.task_type, 0, '工步', 1, '工序', 2, '里程碑', 3,'任务','') task_type, --类型
       pp.project_code, --项目code
       pp.project_name, --项目名称
       c.plan_s_date, --计划开始时间
       c.plan_e_date, --计划结束时间
       c.actual_s_date, --实际开始时间
       c.actual_e_date, --实际结束时间
       (select attribute_07 from mpm.pm_task_info where instr(c.task_path,id)>0 and        task_type='3')attribute_07, --任务项目编号
       c.plan_code_gantt, --任务名称
       c.task_name, --任务名称
       c.task_code, --任务code
       su.login_name, --登入名
       sdv.dept_name, --部门名称
       syu.login_name as PLAN_MANAGER_name, --主管名称
       c.INTERFACE_STATE , --任务状态
       c.parent_id --父节点ID
       from c
left join pt6.sys_user su
    on c.user_id = su.id --通过user_id左连接 系统用户表 拿到 用户登入名
  left join pt6.sys_user syu
    on c.plan_manager_id = syu.id --通过plan_manager_id左连接 系统用户表 拿到 主管名称
  left join pt6.sys_dept_v sdv
    on c.dept_id = sdv.id --通过dept_id左连接 部门表视图 拿到 部门名称
  left join pt6.pm_project pp
    on c.pm_project_id = pp.id --通过pm_project_id左连接 项目结构信息表 拿到 项目code 项目名称
 where c.task_status = '30' --状态 等于30(已下达)
   and nvl(c.ACTUAL_PROGRESS, 0) < 100 --并且 计划实际完成百分比%小于100 order by c.plan_code_gantt


]
[DEBUG] [2018-12-21 00:00:41,313] [15] [	SELECT * FROM MDS_IMP_DATA_SCRIPT]
[DEBUG] [2018-12-21 00:00:41,316] [15] [	SELECT * FROM MDS_IMP_DATA_SCRIPT WHERE FID='1ffb8827cedf4547a45f81513abff23c']
[DEBUG] [2018-12-21 00:00:41,317] [15] [	SELECT * FROM MDS_IMP_DATA_SCRIPT_RULE WHERE FID='1ffb8827cedf4547a45f81513abff23c']
[DEBUG] [2018-12-21 00:00:41,318] [15] [	SELECT * FROM MDS_IMP_DATA_SCRIPT_MAP WHERE MDS_IMP_DATA_SCRIPT_RULE_ID='1ffb8827cedf4547a45f81513abff23c']
[DEBUG] [2018-12-21 00:00:41,319] [15] [	select t.table_name,t.column_name,t.data_type,t.data_length,t.nullable,t.column_id,c.comments
       FROM user_tab_cols t, user_col_comments c
       WHERE upper(t.table_name)='TBL_1220_DATA2'   
             and c.table_name=t.table_name   
             and c.column_name=t.column_name   
             and t.hidden_column='NO'   
 order by t.column_id ]
[INFO ] [2018-12-21 00:00:41,324] [15] [BetchLogic > updateDbByID > 删除数据:TBL_1220_DATA2 -> taskid: 8a53b79267c9ba700167c9bd4c2b0011  times: 1]
[DEBUG] [2018-12-21 00:00:41,324] [15] [	delete from TBL_1220_DATA2 where PROJECTID ='8a53b79267c9ba700167c9bd4c2b0011' and TASKTIMES=1]
[DEBUG] [2018-12-21 00:00:46,153] [15] [	select t.table_name,t.column_name,t.data_type,t.data_length,t.nullable,t.column_id,c.comments
       FROM user_tab_cols t, user_col_comments c
       WHERE upper(t.table_name)='TBL_1220_DATA2'   
             and c.table_name=t.table_name   
             and c.column_name=t.column_name   
             and t.hidden_column='NO'   
 order by t.column_id ]
[DEBUG] [2018-12-21 00:00:46,156] [15] [	INSERT INTO MDS_IMP_DATA_LOG(FID,TEST_PROJECT_ID,IMP_DATE_TIME,FULL_FLODERNAME,IMPROWSCOUNT,IMP_STATUS,ERROR_MSG,CREATED_BY,CREATION_DATE,LAST_UPDATED_BY,LAST_UPDATE_DATE,LAST_UPDATE_IP,VERSION,IMPFILENAME,OBJECT_TABLE,TYPENAME) VALUES('c70fcce6268a47fb95bc9b3567a30d56','8a53b79267c9ba700167c9bd4c2b0011',to_date('2018/12/21 00:00:46','yyyy/mm/dd hh24:mi:ss'),'c70fcce6268a47fb95bc9b3567a30d56.txt','0','','','4028b48152632a160152635092f7000e',to_date('2018/12/21 00:00:46','yyyy/mm/dd hh24:mi:ss'),'4028b48152632a160152635092f7000e',to_date('2018/12/21 00:00:46','yyyy/mm/dd hh24:mi:ss'),'127.0.0.1',1,'sw@1220,1.1.1.1,12202018001,1.txt','TBL_1220_DATA2','1ffb8827cedf4547a45f81513abff23c')]
[DEBUG] [2018-12-21 00:00:46,158] [15] [	select t.table_name,t.column_name,t.data_type,t.data_length,t.nullable,t.column_id,c.comments
       FROM user_tab_cols t, user_col_comments c
       WHERE upper(t.table_name)='TBL_1220_DATA2'   
             and c.table_name=t.table_name   
             and c.column_name=t.column_name   
             and t.hidden_column='NO'   
 order by t.column_id ]
[INFO ] [2018-12-21 00:00:46,161] [15] [BetchLogic > run > 开始导入:2018/12/21 上午12:00:46]
[INFO ] [2018-12-21 00:00:46,472] [15] [BetchLogic > run > 凑够10000行写一次库 :9999]
[INFO ] [2018-12-21 00:00:46,749] [15] [BetchLogic > run > 凑够10000行写一次库 :19999]
[INFO ] [2018-12-21 00:00:47,142] [15] [BetchLogic > run > 凑够10000行写一次库 :29999]
[INFO ] [2018-12-21 00:00:47,422] [15] [BetchLogic > run > 凑够10000行写一次库 :39999]
[INFO ] [2018-12-21 00:00:47,728] [15] [BetchLogic > run > 凑够10000行写一次库 :49999]
[INFO ] [2018-12-21 00:00:48,509] [15] [BetchLogic > run > 凑够10000行写一次库 :59999]
[INFO ] [2018-12-21 00:00:48,825] [15] [BetchLogic > run > 凑够10000行写一次库 :69999]
[INFO ] [2018-12-21 00:00:49,105] [15] [BetchLogic > run > 凑够10000行写一次库 :79999]
[INFO ] [2018-12-21 00:00:49,418] [15] [BetchLogic > run > 凑够10000行写一次库 :89999]
[INFO ] [2018-12-21 00:00:49,694] [15] [BetchLogic > run > 凑够10000行写一次库 :99999]
[INFO ] [2018-12-21 00:00:49,695] [15] [BetchLogic > run > 全部写入完成:100000]
[DEBUG] [2018-12-21 00:28:08,288] [45] [	with a as(select t.parent_id parent_id, min(t.plan_code_gantt) min_task_code
  from mpm.pm_task_info t
 where t.actual_e_date is null
   and (t.accept_state <> '3' or t.accept_state is null)
   and t.task_type = '1'
   and t.id in (select pti.parent_id
                  from mpm.pm_task_info pti left join pt6.sys_user su
                       on pti.user_id = su.id
                 where pti.pm_task_type = '1' and (su.login_name='shaozj' or exists(
                 select 1 from tdm.tdm_task_rsrc_user ttru left join pt6.sys_user su1 on ttru.user_id = su1.id
                 where ttru.task_id = pti.id and su1.login_name = 'shaozj'
                 ))) --包含下达给试验部公布的工序
 group by t.parent_id
),
--查询所有任务下的按顺序应当执行的工序code对应的ID
b as (
  select a.parent_id,a.min_task_code,pti1.id from mpm.pm_task_info pti1,a
  where pti1.parent_id = a.parent_id 
  and pti1.task_name not like '%_A' AND  pti1.task_name NOT LIKE '%_B'
  and pti1.task_name not like '%_C' AND  pti1.task_name NOT LIKE '%_D'
),
--查询带ABCD的科研工序，只能查询上一未做的阶段工序
b1 as(
 select a.parent_id,a.min_task_code,pti1.id from mpm.pm_task_info pti1,a
  where pti1.parent_id = a.parent_id 
    and ((pti1.TASK_NAME  LIKE '%_A' AND nvl(pti1.ACTUAL_PROGRESS,0)<100)
OR(pti1.TASK_NAME LIKE '%_B' AND nvl(pti1.ACTUAL_PROGRESS,0)<100 AND 
 NOT EXISTS(SELECT 1 FROM mpm.PM_TASK_INFO WHERE PARENT_ID=pti1.PARENT_ID AND TASK_NAME LIKE '%_A' 
 AND nvl(ACTUAL_PROGRESS,0)<100))
 OR(pti1.TASK_NAME LIKE '%_C' AND nvl(pti1.ACTUAL_PROGRESS,0)<100 AND 
 NOT EXISTS(SELECT 1 FROM mpm.PM_TASK_INFO WHERE PARENT_ID=pti1.PARENT_ID AND TASK_NAME LIKE '%_B' 
 AND nvl(ACTUAL_PROGRESS,0)<100))
  OR(pti1.TASK_NAME LIKE '%_D' AND nvl(pti1.ACTUAL_PROGRESS,0)<100 AND 
 NOT EXISTS(SELECT 1 FROM mpm.PM_TASK_INFO WHERE PARENT_ID=pti1.PARENT_ID AND TASK_NAME LIKE '%_C' 
 AND nvl(ACTUAL_PROGRESS,0)<100))
 ) 
),
b2 as (
select parent_id,min_task_code,id from b
union all
select parent_id,min_task_code,id from b1
),
--查询该工序节点父节点和子节点的信息
d as(
  select distinct pti2.* from mpm.pm_task_info pti2,b2
  where pti2.parent_id = b2.id or b2.parent_id = pti2.id or pti2.id=b2.id
  and pti2.actual_e_date is null
  and pti2.accept_state <> '3'
),
--过滤工步不为登陆人的工步
c as (
  select d.* from d
  left join pt6.sys_user su
  on d.user_id=su.id
  where (su.login_name='shaozj' or exists(
                 select 1 from tdm.tdm_task_rsrc_user ttru left join pt6.sys_user su1 on ttru.user_id = su1.id
                 where ttru.task_id = d.id and su1.login_name = 'shaozj')) or d.task_type<>0
)
select c.id, --WBS/任务的唯一标识
       decode(c.task_type, 0, '工步', 1, '工序', 2, '里程碑', 3,'任务','') task_type, --类型
       pp.project_code, --项目code
       pp.project_name, --项目名称
       c.plan_s_date, --计划开始时间
       c.plan_e_date, --计划结束时间
       c.actual_s_date, --实际开始时间
       c.actual_e_date, --实际结束时间
       (select attribute_07 from mpm.pm_task_info where instr(c.task_path,id)>0 and        task_type='3')attribute_07, --任务项目编号
       c.plan_code_gantt, --任务名称
       c.task_name, --任务名称
       c.task_code, --任务code
       su.login_name, --登入名
       sdv.dept_name, --部门名称
       syu.login_name as PLAN_MANAGER_name, --主管名称
       c.INTERFACE_STATE , --任务状态
       c.parent_id --父节点ID
       from c
left join pt6.sys_user su
    on c.user_id = su.id --通过user_id左连接 系统用户表 拿到 用户登入名
  left join pt6.sys_user syu
    on c.plan_manager_id = syu.id --通过plan_manager_id左连接 系统用户表 拿到 主管名称
  left join pt6.sys_dept_v sdv
    on c.dept_id = sdv.id --通过dept_id左连接 部门表视图 拿到 部门名称
  left join pt6.pm_project pp
    on c.pm_project_id = pp.id --通过pm_project_id左连接 项目结构信息表 拿到 项目code 项目名称
 where c.task_status = '30' --状态 等于30(已下达)
   and nvl(c.ACTUAL_PROGRESS, 0) < 100 --并且 计划实际完成百分比%小于100 order by c.plan_code_gantt


]
[DEBUG] [2018-12-21 00:28:08,373] [45] [	SELECT * FROM MDS_IMP_DATA_SCRIPT]
[DEBUG] [2018-12-21 00:28:08,379] [45] [	SELECT * FROM MDS_IMP_DATA_SCRIPT WHERE FID='512950b178534c24a6033392af0bd08d']
[DEBUG] [2018-12-21 00:28:08,380] [45] [	SELECT * FROM MDS_IMP_DATA_SCRIPT_RULE WHERE FID='512950b178534c24a6033392af0bd08d']
[DEBUG] [2018-12-21 00:28:08,383] [45] [	SELECT * FROM MDS_IMP_DATA_SCRIPT_MAP WHERE MDS_IMP_DATA_SCRIPT_RULE_ID='512950b178534c24a6033392af0bd08d']
[DEBUG] [2018-12-21 00:28:08,386] [45] [	select t.table_name,t.column_name,t.data_type,t.data_length,t.nullable,t.column_id,c.comments
       FROM user_tab_cols t, user_col_comments c
       WHERE upper(t.table_name)='TBL_1220_DATA1'   
             and c.table_name=t.table_name   
             and c.column_name=t.column_name   
             and t.hidden_column='NO'   
 order by t.column_id ]
[INFO ] [2018-12-21 00:28:08,391] [45] [BetchLogic > updateDbByID > 删除数据:TBL_1220_DATA1 -> taskid: 8a53b79267c9ba700167c9bd4c2b0011  times: 1]
[DEBUG] [2018-12-21 00:28:08,392] [45] [	delete from TBL_1220_DATA1 where PROJECTID ='8a53b79267c9ba700167c9bd4c2b0011' and TASKTIMES=1]
[DEBUG] [2018-12-21 00:28:09,028] [45] [	select t.table_name,t.column_name,t.data_type,t.data_length,t.nullable,t.column_id,c.comments
       FROM user_tab_cols t, user_col_comments c
       WHERE upper(t.table_name)='TBL_1220_DATA1'   
             and c.table_name=t.table_name   
             and c.column_name=t.column_name   
             and t.hidden_column='NO'   
 order by t.column_id ]
[DEBUG] [2018-12-21 00:28:09,033] [45] [	INSERT INTO MDS_IMP_DATA_LOG(FID,TEST_PROJECT_ID,IMP_DATE_TIME,FULL_FLODERNAME,IMPROWSCOUNT,IMP_STATUS,ERROR_MSG,CREATED_BY,CREATION_DATE,LAST_UPDATED_BY,LAST_UPDATE_DATE,LAST_UPDATE_IP,VERSION,IMPFILENAME,OBJECT_TABLE,TYPENAME) VALUES('05de1b943809413c9c4b9025e4c349f0','8a53b79267c9ba700167c9bd4c2b0011',to_date('2018/12/21 00:28:09','yyyy/mm/dd hh24:mi:ss'),'05de1b943809413c9c4b9025e4c349f0.txt','0','','','4028b48152632a160152635092f7000e',to_date('2018/12/21 00:28:09','yyyy/mm/dd hh24:mi:ss'),'4028b48152632a160152635092f7000e',to_date('2018/12/21 00:28:09','yyyy/mm/dd hh24:mi:ss'),'127.0.0.1',1,'mx@1220,1.1.1.1,12202018000,1.txt','TBL_1220_DATA1','512950b178534c24a6033392af0bd08d')]
[DEBUG] [2018-12-21 00:28:09,038] [45] [	select t.table_name,t.column_name,t.data_type,t.data_length,t.nullable,t.column_id,c.comments
       FROM user_tab_cols t, user_col_comments c
       WHERE upper(t.table_name)='TBL_1220_DATA1'   
             and c.table_name=t.table_name   
             and c.column_name=t.column_name   
             and t.hidden_column='NO'   
 order by t.column_id ]
[INFO ] [2018-12-21 00:28:09,042] [45] [BetchLogic > run > 开始导入:2018/12/21 上午12:28:09]
[INFO ] [2018-12-21 00:28:09,886] [45] [BetchLogic > run > 凑够10000行写一次库 :9999]
[INFO ] [2018-12-21 00:28:10,211] [45] [BetchLogic > run > 凑够10000行写一次库 :19999]
[INFO ] [2018-12-21 00:28:10,488] [45] [BetchLogic > run > 凑够10000行写一次库 :29999]
[INFO ] [2018-12-21 00:28:10,803] [45] [BetchLogic > run > 凑够10000行写一次库 :39999]
[INFO ] [2018-12-21 00:28:11,069] [45] [BetchLogic > run > 凑够10000行写一次库 :49999]
[INFO ] [2018-12-21 00:28:11,392] [45] [BetchLogic > run > 凑够10000行写一次库 :59999]
[INFO ] [2018-12-21 00:28:12,324] [45] [BetchLogic > run > 凑够10000行写一次库 :69999]
[INFO ] [2018-12-21 00:28:12,640] [45] [BetchLogic > run > 凑够10000行写一次库 :79999]
[INFO ] [2018-12-21 00:28:12,946] [45] [BetchLogic > run > 凑够10000行写一次库 :89999]
[INFO ] [2018-12-21 00:28:13,289] [45] [BetchLogic > run > 凑够10000行写一次库 :99999]
[INFO ] [2018-12-21 00:28:13,289] [45] [BetchLogic > run > 全部写入完成:100000]
[DEBUG] [2018-12-21 00:28:13,598] [44] [	with a as(select t.parent_id parent_id, min(t.plan_code_gantt) min_task_code
  from mpm.pm_task_info t
 where t.actual_e_date is null
   and (t.accept_state <> '3' or t.accept_state is null)
   and t.task_type = '1'
   and t.id in (select pti.parent_id
                  from mpm.pm_task_info pti left join pt6.sys_user su
                       on pti.user_id = su.id
                 where pti.pm_task_type = '1' and (su.login_name='shaozj' or exists(
                 select 1 from tdm.tdm_task_rsrc_user ttru left join pt6.sys_user su1 on ttru.user_id = su1.id
                 where ttru.task_id = pti.id and su1.login_name = 'shaozj'
                 ))) --包含下达给试验部公布的工序
 group by t.parent_id
),
--查询所有任务下的按顺序应当执行的工序code对应的ID
b as (
  select a.parent_id,a.min_task_code,pti1.id from mpm.pm_task_info pti1,a
  where pti1.parent_id = a.parent_id 
  and pti1.task_name not like '%_A' AND  pti1.task_name NOT LIKE '%_B'
  and pti1.task_name not like '%_C' AND  pti1.task_name NOT LIKE '%_D'
),
--查询带ABCD的科研工序，只能查询上一未做的阶段工序
b1 as(
 select a.parent_id,a.min_task_code,pti1.id from mpm.pm_task_info pti1,a
  where pti1.parent_id = a.parent_id 
    and ((pti1.TASK_NAME  LIKE '%_A' AND nvl(pti1.ACTUAL_PROGRESS,0)<100)
OR(pti1.TASK_NAME LIKE '%_B' AND nvl(pti1.ACTUAL_PROGRESS,0)<100 AND 
 NOT EXISTS(SELECT 1 FROM mpm.PM_TASK_INFO WHERE PARENT_ID=pti1.PARENT_ID AND TASK_NAME LIKE '%_A' 
 AND nvl(ACTUAL_PROGRESS,0)<100))
 OR(pti1.TASK_NAME LIKE '%_C' AND nvl(pti1.ACTUAL_PROGRESS,0)<100 AND 
 NOT EXISTS(SELECT 1 FROM mpm.PM_TASK_INFO WHERE PARENT_ID=pti1.PARENT_ID AND TASK_NAME LIKE '%_B' 
 AND nvl(ACTUAL_PROGRESS,0)<100))
  OR(pti1.TASK_NAME LIKE '%_D' AND nvl(pti1.ACTUAL_PROGRESS,0)<100 AND 
 NOT EXISTS(SELECT 1 FROM mpm.PM_TASK_INFO WHERE PARENT_ID=pti1.PARENT_ID AND TASK_NAME LIKE '%_C' 
 AND nvl(ACTUAL_PROGRESS,0)<100))
 ) 
),
b2 as (
select parent_id,min_task_code,id from b
union all
select parent_id,min_task_code,id from b1
),
--查询该工序节点父节点和子节点的信息
d as(
  select distinct pti2.* from mpm.pm_task_info pti2,b2
  where pti2.parent_id = b2.id or b2.parent_id = pti2.id or pti2.id=b2.id
  and pti2.actual_e_date is null
  and pti2.accept_state <> '3'
),
--过滤工步不为登陆人的工步
c as (
  select d.* from d
  left join pt6.sys_user su
  on d.user_id=su.id
  where (su.login_name='shaozj' or exists(
                 select 1 from tdm.tdm_task_rsrc_user ttru left join pt6.sys_user su1 on ttru.user_id = su1.id
                 where ttru.task_id = d.id and su1.login_name = 'shaozj')) or d.task_type<>0
)
select c.id, --WBS/任务的唯一标识
       decode(c.task_type, 0, '工步', 1, '工序', 2, '里程碑', 3,'任务','') task_type, --类型
       pp.project_code, --项目code
       pp.project_name, --项目名称
       c.plan_s_date, --计划开始时间
       c.plan_e_date, --计划结束时间
       c.actual_s_date, --实际开始时间
       c.actual_e_date, --实际结束时间
       (select attribute_07 from mpm.pm_task_info where instr(c.task_path,id)>0 and        task_type='3')attribute_07, --任务项目编号
       c.plan_code_gantt, --任务名称
       c.task_name, --任务名称
       c.task_code, --任务code
       su.login_name, --登入名
       sdv.dept_name, --部门名称
       syu.login_name as PLAN_MANAGER_name, --主管名称
       c.INTERFACE_STATE , --任务状态
       c.parent_id --父节点ID
       from c
left join pt6.sys_user su
    on c.user_id = su.id --通过user_id左连接 系统用户表 拿到 用户登入名
  left join pt6.sys_user syu
    on c.plan_manager_id = syu.id --通过plan_manager_id左连接 系统用户表 拿到 主管名称
  left join pt6.sys_dept_v sdv
    on c.dept_id = sdv.id --通过dept_id左连接 部门表视图 拿到 部门名称
  left join pt6.pm_project pp
    on c.pm_project_id = pp.id --通过pm_project_id左连接 项目结构信息表 拿到 项目code 项目名称
 where c.task_status = '30' --状态 等于30(已下达)
   and nvl(c.ACTUAL_PROGRESS, 0) < 100 --并且 计划实际完成百分比%小于100 order by c.plan_code_gantt


]
[DEBUG] [2018-12-21 00:28:13,625] [44] [	SELECT * FROM MDS_IMP_DATA_SCRIPT]
[DEBUG] [2018-12-21 00:28:13,629] [44] [	SELECT * FROM MDS_IMP_DATA_SCRIPT WHERE FID='1ffb8827cedf4547a45f81513abff23c']
[DEBUG] [2018-12-21 00:28:13,630] [44] [	SELECT * FROM MDS_IMP_DATA_SCRIPT_RULE WHERE FID='1ffb8827cedf4547a45f81513abff23c']
[DEBUG] [2018-12-21 00:28:13,631] [44] [	SELECT * FROM MDS_IMP_DATA_SCRIPT_MAP WHERE MDS_IMP_DATA_SCRIPT_RULE_ID='1ffb8827cedf4547a45f81513abff23c']
[DEBUG] [2018-12-21 00:28:13,632] [44] [	select t.table_name,t.column_name,t.data_type,t.data_length,t.nullable,t.column_id,c.comments
       FROM user_tab_cols t, user_col_comments c
       WHERE upper(t.table_name)='TBL_1220_DATA2'   
             and c.table_name=t.table_name   
             and c.column_name=t.column_name   
             and t.hidden_column='NO'   
 order by t.column_id ]
[INFO ] [2018-12-21 00:28:13,635] [44] [BetchLogic > updateDbByID > 删除数据:TBL_1220_DATA2 -> taskid: 8a53b79267c9ba700167c9bd4c2b0011  times: 1]
[DEBUG] [2018-12-21 00:28:13,635] [44] [	delete from TBL_1220_DATA2 where PROJECTID ='8a53b79267c9ba700167c9bd4c2b0011' and TASKTIMES=1]
[DEBUG] [2018-12-21 00:28:15,866] [44] [	select t.table_name,t.column_name,t.data_type,t.data_length,t.nullable,t.column_id,c.comments
       FROM user_tab_cols t, user_col_comments c
       WHERE upper(t.table_name)='TBL_1220_DATA2'   
             and c.table_name=t.table_name   
             and c.column_name=t.column_name   
             and t.hidden_column='NO'   
 order by t.column_id ]
[DEBUG] [2018-12-21 00:28:15,870] [44] [	INSERT INTO MDS_IMP_DATA_LOG(FID,TEST_PROJECT_ID,IMP_DATE_TIME,FULL_FLODERNAME,IMPROWSCOUNT,IMP_STATUS,ERROR_MSG,CREATED_BY,CREATION_DATE,LAST_UPDATED_BY,LAST_UPDATE_DATE,LAST_UPDATE_IP,VERSION,IMPFILENAME,OBJECT_TABLE,TYPENAME) VALUES('01e8f97167534d26915dcdb5b4d14e2e','8a53b79267c9ba700167c9bd4c2b0011',to_date('2018/12/21 00:28:15','yyyy/mm/dd hh24:mi:ss'),'01e8f97167534d26915dcdb5b4d14e2e.txt','0','','','4028b48152632a160152635092f7000e',to_date('2018/12/21 00:28:15','yyyy/mm/dd hh24:mi:ss'),'4028b48152632a160152635092f7000e',to_date('2018/12/21 00:28:15','yyyy/mm/dd hh24:mi:ss'),'127.0.0.1',1,'sw@1220,1.1.1.1,12202018001,1.txt','TBL_1220_DATA2','1ffb8827cedf4547a45f81513abff23c')]
[DEBUG] [2018-12-21 00:28:15,872] [44] [	select t.table_name,t.column_name,t.data_type,t.data_length,t.nullable,t.column_id,c.comments
       FROM user_tab_cols t, user_col_comments c
       WHERE upper(t.table_name)='TBL_1220_DATA2'   
             and c.table_name=t.table_name   
             and c.column_name=t.column_name   
             and t.hidden_column='NO'   
 order by t.column_id ]
[INFO ] [2018-12-21 00:28:15,875] [44] [BetchLogic > run > 开始导入:2018/12/21 上午12:28:15]
[INFO ] [2018-12-21 00:28:18,428] [44] [BetchLogic > run > 凑够10000行写一次库 :9999]
[INFO ] [2018-12-21 00:28:18,708] [44] [BetchLogic > run > 凑够10000行写一次库 :19999]
[INFO ] [2018-12-21 00:28:19,020] [44] [BetchLogic > run > 凑够10000行写一次库 :29999]
[INFO ] [2018-12-21 00:28:19,309] [44] [BetchLogic > run > 凑够10000行写一次库 :39999]
[INFO ] [2018-12-21 00:28:19,614] [44] [BetchLogic > run > 凑够10000行写一次库 :49999]
[INFO ] [2018-12-21 00:28:19,887] [44] [BetchLogic > run > 凑够10000行写一次库 :59999]
[INFO ] [2018-12-21 00:28:20,230] [44] [BetchLogic > run > 凑够10000行写一次库 :69999]
[INFO ] [2018-12-21 00:28:20,501] [44] [BetchLogic > run > 凑够10000行写一次库 :79999]
[INFO ] [2018-12-21 00:28:21,959] [44] [BetchLogic > run > 凑够10000行写一次库 :89999]
[INFO ] [2018-12-21 00:28:22,262] [44] [BetchLogic > run > 凑够10000行写一次库 :99999]
[INFO ] [2018-12-21 00:28:22,262] [44] [BetchLogic > run > 全部写入完成:100000]